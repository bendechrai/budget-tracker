generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id                      String         @id @default(cuid())
  email                   String         @unique
  passwordHash            String
  currencySymbol          String         @default("$")
  onboardingComplete      Boolean        @default(false)
  currentFundBalance      Float          @default(0)
  maxContributionPerCycle  Float?
  contributionCycleDays   Int?
  contributionCycleType   ContributionCycleType?
  contributionPayDays     Int[]          @default([])
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  incomeSources           IncomeSource[]
  fundGroups              FundGroup[]
  obligations             Obligation[]
  transactions            Transaction[]
  importLogs              ImportLog[]
  suggestions             Suggestion[]
  engineSnapshots         EngineSnapshot[]
  aiInteractionLogs       AIInteractionLog[]
  passwordResetTokens     PasswordResetToken[]
}

enum IncomeFrequency {
  weekly
  fortnightly
  twice_monthly
  monthly
  quarterly
  annual
  custom
  irregular
}

model IncomeSource {
  id               String          @id @default(cuid())
  userId           String
  name             String
  expectedAmount   Float
  frequency        IncomeFrequency
  frequencyDays    Int?
  isIrregular      Boolean
  minimumExpected  Float?
  nextExpectedDate DateTime?
  isPaused         Boolean         @default(false)
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id])
  linkedSuggestions Suggestion[]

  @@index([userId])
}

enum ObligationType {
  recurring
  recurring_with_end
  one_off
  custom
}

model FundGroup {
  id          String       @id @default(cuid())
  userId      String
  name        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id])
  obligations Obligation[]

  @@index([userId])
}

model Obligation {
  id            String              @id @default(cuid())
  userId        String
  name          String
  type          ObligationType
  amount        Float
  frequency     IncomeFrequency?
  frequencyDays Int?
  startDate     DateTime
  endDate       DateTime?
  nextDueDate   DateTime
  isPaused      Boolean             @default(false)
  isActive      Boolean             @default(true)
  isArchived    Boolean             @default(false)
  fundGroupId   String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  user          User                @relation(fields: [userId], references: [id])
  fundGroup     FundGroup?          @relation(fields: [fundGroupId], references: [id])
  customEntries CustomScheduleEntry[]
  linkedSuggestions Suggestion[]
  fundBalance      FundBalance?
  contributions    ContributionRecord[]
  escalations      Escalation[]

  @@index([userId])
  @@index([fundGroupId])
}

model CustomScheduleEntry {
  id           String     @id @default(cuid())
  obligationId String
  dueDate      DateTime
  amount       Float
  isPaid       Boolean    @default(false)
  obligation   Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@index([obligationId])
}

enum TransactionType {
  credit
  debit
}

enum ImportFormat {
  pdf
  csv
  ofx
}

model Transaction {
  id             String          @id @default(cuid())
  userId         String
  date           DateTime
  description    String
  amount         Float
  type           TransactionType
  referenceId    String?
  fingerprint    String
  sourceFileName String
  importedAt     DateTime        @default(now())
  createdAt      DateTime        @default(now())
  user           User            @relation(fields: [userId], references: [id])
  suggestionTransactions SuggestionTransaction[]

  @@index([userId])
  @@index([fingerprint])
}

model ImportLog {
  id                    String       @id @default(cuid())
  userId                String
  fileName              String
  format                ImportFormat
  transactionsFound     Int
  transactionsImported  Int
  duplicatesSkipped     Int
  duplicatesFlagged     Int
  importedAt            DateTime     @default(now())
  user                  User         @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum SuggestionType {
  income
  expense
}

enum SuggestionConfidence {
  high
  medium
  low
}

enum SuggestionStatus {
  pending
  accepted
  dismissed
}

model Suggestion {
  id                       String                @id @default(cuid())
  userId                   String
  type                     SuggestionType
  vendorPattern            String
  detectedAmount           Float
  detectedAmountMin        Float?
  detectedAmountMax        Float?
  detectedFrequency        IncomeFrequency
  confidence               SuggestionConfidence
  matchingTransactionCount Int
  status                   SuggestionStatus      @default(pending)
  linkedIncomeSourceId     String?
  linkedObligationId       String?
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  user                     User                  @relation(fields: [userId], references: [id])
  linkedIncomeSource       IncomeSource?         @relation(fields: [linkedIncomeSourceId], references: [id])
  linkedObligation         Obligation?           @relation(fields: [linkedObligationId], references: [id])
  suggestionTransactions   SuggestionTransaction[]

  @@index([userId])
  @@index([status])
}

model SuggestionTransaction {
  suggestionId  String
  transactionId String
  suggestion    Suggestion  @relation(fields: [suggestionId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@id([suggestionId, transactionId])
  @@index([transactionId])
}

enum ContributionCycleType {
  weekly
  fortnightly
  twice_monthly
  monthly
}

enum EscalationChangeType {
  absolute
  percentage
  fixed_increase
}

enum ContributionType {
  contribution
  manual_adjustment
}

model FundBalance {
  id            String     @id @default(cuid())
  obligationId  String     @unique
  currentBalance Float     @default(0)
  lastUpdatedAt DateTime   @updatedAt
  obligation    Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)
}

model ContributionRecord {
  id           String           @id @default(cuid())
  obligationId String
  amount       Float
  date         DateTime
  type         ContributionType
  note         String?
  createdAt    DateTime         @default(now())
  obligation   Obligation       @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@index([obligationId])
}

model EngineSnapshot {
  id                    String   @id @default(cuid())
  userId                String
  calculatedAt          DateTime @default(now())
  totalRequired         Float
  totalFunded           Float
  nextActionAmount      Float
  nextActionDate        DateTime
  nextActionDescription String
  user                  User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AIInteractionLog {
  id           String   @id @default(cuid())
  userId       String
  rawInput     String
  parsedIntent Json
  actionTaken  String
  success      Boolean
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Escalation {
  id             String               @id @default(cuid())
  obligationId   String
  changeType     EscalationChangeType
  value          Decimal
  effectiveDate  DateTime
  intervalMonths Int?
  isApplied      Boolean              @default(false)
  appliedAt      DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  obligation     Obligation           @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@index([obligationId])
}
